{% macro validate_version() %}
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "required": ["version"],
    "properties": {
        "version": {
            "type": "string",
            "enum": ["1.0", "1.1", "2.0", "2.1", "2.2", "2.3", "2.4", "2.5", "2.6"]
        }
    }
}
{% endmacro %}

{% macro validate(version) %}
{% if version >= "2.0" %}
{%     set sdp_vis = "sdp.vis" %}
{% else %}
{%     set sdp_vis = "sdp.l0" %}
{% endif %}

{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "definitions": {
        "stream_name": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_]+$"
        },
        "stream_type": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_.]+$"
        },
        "src_streams": {
            "type": "array",
            "items": {"$ref": "#/definitions/stream_name"}
        },
        "nonneg_integer": {
            "type": "integer",
            "minimum": 0
        },
        "positive_integer": {
            "type": "integer",
            "minimum": 1
        },
        "nonneg_number": {
            "type": "number",
            "minimum": 0.0
        },
        "positive_number": {
            "type": "number",
            "exclusiveMinimum": 0.0
        },
        "continuum_parameters": {
            "type": "object",
            "patternProperties": {
                "^[A-Za-z_][A-Za-z0-9_]*$": {}
            },
            "additionalProperties": false
        },
        "singleton": {
            "type": "array",
            "minItems": 1,
            "maxItems": 1
        },
        "pair": {
            "type": "array",
            "minItems": 2,
            "maxItems": 2
        },
        "channel_range": {
            "$ref": "#/definitions/pair",
            "items": {"$ref": "#/definitions/nonneg_integer"}
        },
        "simulate": {
{% if version >= "1.1" %}
            "oneOf": [
                {"type": "boolean"},
                {
                    "type": "object",
                    "properties": {
{% if version >= "2.4" %}
                        "clock_ratio": {"type": "number", "minimum": 0.0, "default": 1.0},
                        "start_time": {"$ref": "#/definitions/positive_number"},
{% endif %}
                        "sources": {
                            "type": "array",
                            "items": {"type": "string"}
                        },
                        "antennas": {
                            "type": "array",
                            "items": {"type": "string"}
                        },
                        "center_freq": {"$ref": "#/definitions/positive_number"}
                    },
                    "additionalProperties": false
                }
            ],
{% else %}
            "type": "boolean",
{% endif %}
            "default": false
        },
        "simulate_bool": {
            "type": "boolean",
            "default": false
        }
    },
    "type": "object",
    "required": ["inputs", "outputs", "config", "version"],
    "additionalProperties": false,
    "properties": {
        "inputs": {
            "type": "object",
            "additionalProperties": false,
            "patternProperties": {
                "^[A-Za-z0-9_]+$": {
                    "type": "object",
                    "required": ["type", "url"],
                    "properties": {
                        "type": {"$ref": "#/definitions/stream_type"},
                        "url": {"type": "string", "format": "uri"},
                        "src_streams": {"$ref": "#/definitions/src_streams"}
                    },
                    "allOf": [
                        {
                            "if": {"properties": {"type": {"const": "cbf.antenna_channelised_voltage"}}},
                            "then": {
                                "properties": {
                                    "antennas": {
                                        "type": "array",
                                        "minItems": 1,
                                        "items": {"type": "string"}
                                    },
                                    "n_chans": {"$ref": "#/definitions/nonneg_integer"},
                                    "n_samples_between_spectra": {
                                        "$ref": "#/definitions/nonneg_integer"
                                    },
                                    "n_pols": {"type": "integer", "enum": [1, 2]},
                                    "adc_sample_rate": {"type": "number"},
                                    "bandwidth": {"type": "number"},
                                    "instrument_dev_name": {"type": "string"}
                                },
                                "required": [
                                    "antennas",
                                    "n_chans", "n_samples_between_spectra", "n_pols",
                                    "adc_sample_rate", "bandwidth", "instrument_dev_name"
                                ]
                            }
                        },
                        {
                            "if": {"properties": {"type": {"const": "cbf.baseline_correlation_products"}}},
                            "then": {
                                "properties": {
                                    "src_streams": {"$ref": "#/definitions/singleton"},
                                    "int_time": {"type": "number"},
                                    "n_bls": {"$ref": "#/definitions/nonneg_integer"},
                                    "xeng_out_bits_per_sample": {"enum": [32]},
                                    "n_chans_per_substream": {
                                        "$ref": "#/definitions/nonneg_integer"
                                    },
                                    "instrument_dev_name": {"type": "string"},
                                    "simulate": {"$ref": "#/definitions/simulate"}
                                },
                                "required": [
                                    "src_streams", "int_time", "n_bls",
                                    "xeng_out_bits_per_sample", "n_chans_per_substream",
                                    "instrument_dev_name"
                                ]
                            }
                        },
                        {
                            "if": {"properties": {"type": {"const": "cbf.tied_array_channelised_voltage"}}},
                            "then": {
                                "properties": {
                                    "src_streams": {"$ref": "#/definitions/singleton"},
                                    "beng_out_bits_per_sample": {"enum": [8]},
                                    "spectra_per_heap": {
                                        "$ref": "#/definitions/nonneg_integer"
                                    },
                                    "n_chans_per_substream": {
                                        "$ref": "#/definitions/nonneg_integer"
                                    },
                                    "instrument_dev_name": {"type": "string"},
                                    "simulate": {"$ref": "#/definitions/simulate"}
                                },
                                "required": [
                                    "src_streams", "beng_out_bits_per_sample",
                                    "spectra_per_heap",
                                    "n_chans_per_substream", "instrument_dev_name"
                                ]
                            }
                        },
                        {
                            "if": {"properties": {"type": {"const": "cam.http"}}},
                            "then": {}
                        }
                    ]
                }
            }
        },
        "outputs": {
            "type": "object",
            "additionalProperties": false,
            "patternProperties": {
                "^[A-Za-z0-9_]+$": {
                    "type": "object",
                    "required": ["type"],
                    "properties": {
                        "type": {
                            "enum": [
                                "{{sdp_vis}}",
{% if version >= "1.1" %}
                                "sdp.cal",
{% endif %}
{% if version >= "2.0" %}
                                "sdp.flags",
{% endif %}
{% if version >= "2.2" %}
                                "sdp.continuum_image",
{% endif %}
{% if version >= "2.4" %}
                                "sdp.spectral_image",
{% endif %}
                                "sdp.beamformer",
                                "sdp.beamformer_engineering"
                            ]
                        },
                        "src_streams": {"$ref": "#/definitions/src_streams"}
                    },
                    "additionalProperties": true,
                    "allOf": [
                        {
                            "if": {"properties": {"type": {"const": "{{sdp_vis}}"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {"$ref": "#/definitions/singleton"},
                                    "output_int_time": {"type": "number"},
                                    "output_channels": {"$ref": "#/definitions/channel_range"},
                                    "continuum_factor": {
                                        "$ref": "#/definitions/positive_integer"
                                    },
{% if version >= "2.0" %}
                                    "archive": {"type": "boolean"},
{% endif %}
                                    "excise": {"type": "boolean", "default": true}
                                },
                                "required": [
                                    "src_streams", "output_int_time", "continuum_factor"
                                ],
                                "additionalProperties": false
                            }
                        },
                        {
                            "if": {"properties": {"type": {"const": "sdp.beamformer_engineering"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {"$ref": "#/definitions/pair"},
                                    "output_channels": {"$ref": "#/definitions/channel_range"},
                                    "store": {
                                        "enum": ["ram", "ssd"]
                                    }
                                },
                                "required": ["src_streams", "store"],
                                "additionalProperties": false
                            }
                        },
                        {
                            "if": {"properties": {"type": {"const": "sdp.beamformer"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {"$ref": "#/definitions/pair"}
                                },
                                "required": ["src_streams"],
                                "additionalProperties": false
                            }
                        }
{% if version >= "1.1" %}
                        ,
                        {
                            "if": {"properties": {"type": {"const": "sdp.cal"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {"$ref": "#/definitions/singleton"},
                                    "parameters": {
                                        "type": "object",
                                        "properties": {
                                            "preferred_refants": {
                                                "type": "array",
                                                "items": {"type": "string"},
                                                "minItems": 1,
                                                "uniqueItems": true
                                            },
                                            "k_solint": {"$ref": "#/definitions/positive_number"},
                                            "k_chan_sample": {"$ref": "#/definitions/positive_integer"},
                                            "k_bchan": {"$ref": "#/definitions/nonneg_integer"},
                                            "k_echan": {"$ref": "#/definitions/nonneg_integer"},
                                            "kcross_chanave": {"$ref": "#/definitions/positive_integer"},
                                            "bp_solint": {"$ref": "#/definitions/positive_number"},
                                            "g_solint": {"$ref": "#/definitions/positive_number"},
                                            "g_bchan": {"$ref": "#/definitions/nonneg_integer"},
                                            "g_echan": {"$ref": "#/definitions/nonneg_integer"},
                                            "rfi_calib_nsigma": {"$ref": "#/definitions/positive_number"},
                                            "rfi_targ_nsigma": {"$ref": "#/definitions/positive_number"},
                                            "rfi_windows_freq": {
                                                "type": "array",
                                                "items": {"$ref": "#/definitions/positive_integer"},
                                                "minItems": 1,
                                                "uniqueItems": true
                                            },
                                            "rfi_average_freq": {"$ref": "#/definitions/positive_integer"},
                                            "rfi_targ_spike_width_freq": {"$ref": "#/definitions/positive_number"},
                                            "rfi_calib_spike_width_freq": {"$ref": "#/definitions/positive_number"},
                                            "rfi_spike_width_time": {"$ref": "#/definitions/positive_number"},
                                            "rfi_extend_freq": {"$ref": "#/definitions/nonneg_integer"},
                                            "rfi_freq_chunks": {"$ref": "#/definitions/positive_integer"}
                                        },
                                        "additionalProperties": false
                                    },
                                    "models": {
                                        "type": "object",
                                        "additionalProperties": {"type": "string"}
                                    },
{% if version >= "2.1" %}
                                    "max_scans": {"$ref": "#/definitions/positive_integer"},
{% endif %}
                                    "buffer_time": {"$ref": "#/definitions/positive_number"}
                                },
                                "required": ["src_streams"],
                                "additionalProperties": false
                            }
                        }
{% endif %}
{% if version >= "2.0" %}
                        ,
                        {
                            "if": {"properties": {"type": {"const": "sdp.flags"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {"$ref": "#/definitions/singleton"},
                                    "calibration": {"$ref": "#/definitions/singleton"},
                                    "rate_ratio": {
                                        "type": "number",
                                        "exclusiveMinimum": 1.0
                                    },
                                    "archive": {"type": "boolean"}
                                },
                                "required": ["src_streams", "calibration", "archive"],
                                "additionalProperties": false
                            }
                        }
{% endif %}
{% if version >= "2.2" %}
                        ,
                        {
                            "if": {"properties": {"type": {"const": "sdp.continuum_image"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {"$ref": "#/definitions/singleton"},
                                    "uvblavg_parameters": {"$ref": "#/definitions/continuum_parameters"},
                                    "mfimage_parameters": {"$ref": "#/definitions/continuum_parameters"},
{% if version >= "2.5" %}
                                    "min_time": {"$ref": "#/definitions/positive_number"},
{% endif %}
                                    "max_realtime": {"$ref": "#/definitions/nonneg_number"}
                                },
                                "required": ["src_streams"],
                                "additionalProperties": false
                            }
                        }
{% endif %}
{% if version >= "2.4" %}
                        ,
                        {
                            "if": {"properties": {"type": {"const": "sdp.spectral_image"}}},
                            "then": {
                                "properties": {
                                    "type": {},
                                    "src_streams": {
                                        "type": "array",
                                        "minItems": 1,
                                        "maxItems": 2
                                    },
{% if version >= "2.5" %}
                                    "min_time": {"$ref": "#/definitions/positive_number"},
{% endif %}
{% if version >= "2.6" %}
                                    "parameters": {
                                        "type": "object",
                                        "properties": {
                                            "robustness": {"type": "number"},
                                            "grid_oversample": {"$ref": "#/definitions/positive_integer"},
                                            "kernel_image_oversample": {"$ref": "#/definitions/positive_integer"},
                                            "w_slices": {"$ref": "#/definitions/positive_integer"},
                                            "aa_width": {"$ref": "#/definitions/positive_number"},
                                            "kernel_width": {"$ref": "#/definitions/positive_integer"},
                                            "eps_w": {"$ref": "#/definitions/positive_number"},
                                            "primary_beam_cutoff": {"$ref": "#/definitions/positive_number"},
                                            "psf_cutoff": {"$ref": "#/definitions/positive_number"},
                                            "psf_limit": {"$ref": "#/definitions/positive_number"},
                                            "loop_gain": {"$ref": "#/definitions/positive_number"},
                                            "major_gain": {"$ref": "#/definitions/positive_number"},
                                            "threshold": {"$ref": "#/definitions/positive_number"},
                                            "major": {"$ref": "#/definitions/positive_integer"},
                                            "minor": {"$ref": "#/definitions/positive_integer"},
                                            "border": {"$ref": "#/definitions/positive_number"},
                                            "clean_mode": {
                                                "type": "string",
                                                "enum": ["I", "IQUV"]
                                            }
                                        },
                                        "additionalProperties": false
                                    },
{% endif %}
                                    "output_channels": {"$ref": "#/definitions/channel_range"}
                                },
                                "required": ["src_streams"],
                                "additionalProperties": false
                            }
                        }
{% endif %}
                    ]
                }
            }
        },
        "config": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "develop": {"type": "boolean", "default": false},
                "wrapper": {"type": "string", "format": "uri"},
                "image_tag": {"type": "string" },
                "service_overrides": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "config": { "type": "object" },
{% if version >= "2.3" %}
                            "host": { "type": "string" },
{% endif %}
                            "taskinfo": { "type": "object" }
                        }
                    }
                }
            }
        },
        "version": {
            "type": "string",
            "enum": ["{{version}}"]
        }
    }
}
{% endmacro %}
